import os
import requests
import time
import threading
import json
from http.server import HTTPServer, BaseHTTPRequestHandler
from datetime import datetime

# ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ó –û–ö–†–£–ñ–ï–ù–ò–Ø =====
ID_INSTANCE = os.environ.get('ID_INSTANCE')
API_TOKEN = os.environ.get('API_TOKEN')
MAX_CHAT_ID = os.environ.get('MAX_CHAT_ID')
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID')
# ===================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if not all([ID_INSTANCE, API_TOKEN, MAX_CHAT_ID, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID]):
    missing = [v for v in ['ID_INSTANCE', 'API_TOKEN', 'MAX_CHAT_ID', 'TELEGRAM_BOT_TOKEN', 'TELEGRAM_CHAT_ID'] 
               if not os.environ.get(v)]
    raise ValueError(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: {', '.join(missing)}")

# ===== –•–†–ê–ù–ò–õ–ò–©–ï –û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô =====
processed_messages = set()

def get_chat_history(count=5):
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ count —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞ Max"""
    url = f"https://api.green-api.com/waInstance{ID_INSTANCE}/GetChatHistory/{API_TOKEN}"
    payload = {
        "chatId": MAX_CHAT_ID,
        "count": count
    }
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            return response.json()
        return []
    except:
        return []

def send_text_to_telegram(text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram"""
    try:
        requests.post(f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage",
                     json={"chat_id": TELEGRAM_CHAT_ID, "text": text}, timeout=10)
    except:
        pass

# ===== –í–ï–ë-–°–ï–†–í–ï–† =====
class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Diagnostic mode")
    
    def do_HEAD(self):
        self.send_response(200)
        self.end_headers()
    
    def log_message(self, format, *args): pass

def run_http_server():
    port = int(os.environ.get('PORT', 10000))
    server = HTTPServer(('0.0.0.0', port), Handler)
    print(f"üåê –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}")
    server.serve_forever()

web_thread = threading.Thread(target=run_http_server, daemon=True)
web_thread.start()
# =====================

print("=" * 50)
print("üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–†–û–í–ï–†–ö–ê –°–¢–†–£–ö–¢–£–†–´ –°–û–û–ë–©–ï–ù–ò–ô")
print("=" * 50)
print("üü¢ –ó–∞–ø—É—â–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –°–û–û–ë–©–ï–ù–ò–ï –° –û–¢–í–ï–¢–û–ú –≤ —á–∞—Ç\n")

while True:
    try:
        history = get_chat_history(5)
        
        if history and isinstance(history, list):
            for msg in history:
                msg_id = msg.get('idMessage')
                
                if not msg_id or msg_id in processed_messages:
                    continue
                
                # –í—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è
                print("\n" + "="*60)
                print(f"üì¶ –°–û–û–ë–©–ï–ù–ò–ï ID: {msg_id}")
                print(f"üìå –¢–∏–ø: {msg.get('typeMessage', 'unknown')}")
                print("üìÑ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:")
                print(json.dumps(msg, indent=2, ensure_ascii=False))
                print("="*60 + "\n")
                
                processed_messages.add(msg_id)
                
                # –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
                if msg.get('typeMessage') == 'textMessage':
                    text = msg.get('textMessage', '')
                    if text:
                        send_text_to_telegram(f"üì® {msg.get('senderName', 'Unknown')}: {text[:50]}...")
        
        time.sleep(2)
        
    except KeyboardInterrupt:
        print("\n\nüëã –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        break
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        time.sleep(5)
